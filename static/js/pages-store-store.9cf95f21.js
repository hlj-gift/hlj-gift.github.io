(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-store-store"],{"09e9":function(t,n,e){"use strict";e.r(n);var i=e("e67c"),o=e.n(i);for(var a in i)["default"].indexOf(a)<0&&function(t){e.d(n,t,(function(){return i[t]}))}(a);n["default"]=o.a},"8b08":function(t,n,e){"use strict";e.r(n);var i=e("faf3"),o=e("09e9");for(var a in o)["default"].indexOf(a)<0&&function(t){e.d(n,t,(function(){return o[t]}))}(a);var c=e("828b"),r=Object(c["a"])(o["default"],i["b"],i["c"],!1,null,"8fa83c74",null,!1,i["a"],void 0);n["default"]=r.exports},e67c:function(t,n,e){"use strict";(function(t){e("6a54");var i=e("f5bd").default;Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var o=i(e("39d8"));e("5ef2"),e("64aa"),e("dc8a"),e("aa9c"),e("5c47"),e("2c10"),e("23f4"),e("7d2f"),e("9c4e"),e("ab80");var a=getApp(),c=t.database(),r=a.globalData,u=e("235a"),s=e("7033").cbq,d=e("70b4"),l=null,f={data:function(){return{login:!1,account:"",password:"",autologin:!1,info:r.info,users:[]}},onLoad:function(){l=this;var t=uni.getStorageSync("STOREKEY");t&&t.account&&(l.account=t.account,t.password&&(l.password=t.password,l.autologin=!0))},methods:{checkdate:function(){return!((new Date).getHours()>21)||(uni.showToast({title:"已过期",icon:"error"}),!1)},deltikfromcode:function(t){var n={content:t},e=n.content.indexOf("T"),i=n.content.indexOf("BLK");if(-1==e||-1==i)return l.ticket_temp=n.content,uni.showToast({title:"券码无效",icon:"error"});var a=n.content.substring(e),r=Number(a.substring(1));if(d.formatDateToString(new Date(r)).split(" ")[0]!=d.formatDateToString(new Date).split(" ")[0])return uni.showToast({title:"券码已过期",icon:"error"});var u=n.content.substring(0,i),f=n.content.substring(i+3,e);uni.showLoading({mask:!0}),s(c.collection("Gdata").doc(a).get(),{success:function(t){if(uni.hideLoading(),t.data[0]){var n=t.data[0].successIndex[f];if(t.data[0].users[n]==u){if(t.data[0].checked&&t.data[0].checked["m"+u])return void uni.showModal({title:"核销失败",content:"券码已被使用\n使用时间："+t.data[0].checked["m"+u],showCancel:!1});var e=l.prepareData(),i=l.info.reward[t.data[0].group][f];return-1==e.indexOf(i)?void uni.showToast({title:"券码无效",icon:"error"}):void uni.showModal({title:"确认核销？",content:"手机号："+u+"\n奖品："+i,success:function(t){t.confirm&&(l.ticket_temp="",uni.showLoading({mask:!0}),c.collection("Gdata").doc(a).update({checked:(0,o.default)({},"m"+u,d.formatDateToString(new Date))}).then((function(t){t=t.result;t.updated?(uni.showToast({title:"成功"}),l.refreshda()):uni.showToast({title:"券码不存在",icon:"error"}),setTimeout((function(){uni.hideLoading(),l.loading=!1}),1e3)})).catch((function(t){setTimeout((function(){uni.hideLoading(),l.loading=!1,uni.showToast({title:"网络繁忙",icon:"error"})}),1e3)})))}})}}return uni.showToast({title:"券码无效",icon:"error"})},fail:function(t){return uni.showToast({title:"券码无效",icon:"error"})}})},deltikscan:function(t){if(l.checkdate())return 1==t?uni.showModal({title:"网页端不支持使用扫码核销",content:"如需扫码请使用小程序端进行核销",showCancel:!1}):void uni.showModal({title:"请输入券码",editable:!0,content:l.ticket_temp?l.ticket_temp:"",fail:function(t){console.error(t),uni.hideLoading(),uni.showToast({title:"网络繁忙",icon:"error"})},success:function(t){t.confirm&&t.content&&l.deltikfromcode(t.content)}})},prepareData:function(){var t=Object.keys(l.info.location),n=[],e=l.info.location;for(var i in t){var o=t[i],a=e[o];a==l.account&&n.push(o)}return n},setauto:function(t){l.autologin=!l.autologin},deltik:function(t,n){l.checkdate()&&uni.showModal({title:"确认核销？",content:"手机号："+t.id+"\n奖品："+t.reward,success:function(e){if(e.confirm){var i=t._id;uni.showLoading({mask:!0}),c.collection("Gdata").doc(i).update({checked:(0,o.default)({},"m"+t.id,d.formatDateToString(new Date))}).then((function(t){t=t.result;t.updated?(uni.showToast({title:"成功"}),l.users[n].checked=!0):uni.showToast({title:"券码不存在",icon:"error"}),setTimeout((function(){uni.hideLoading(),l.loading=!1}),1e3)})).catch((function(t){setTimeout((function(){uni.hideLoading(),l.loading=!1,uni.showToast({title:"网络繁忙",icon:"fail"})}),1e3)}))}}})},refreshda:function(){if(l.login){l.users=[];var t=d.formatDateToString(new Date).split(" ")[0];c.command.aggregate;s(c.collection("Gdata").aggregate().match({group:new RegExp(t+".*","i")}).end(),{success:function(t){var n=[],e=l.prepareData();for(var i in t.data){var o=t.data[i],a=l.info.reward[o.group];if(a){var c=[];for(var r in a)-1!=e.indexOf(a[r])&&c.push([r,a[r]]);for(var r in c){var u=c[r],s=o.users[o.successIndex[u[0]]];s||(s="未发放"),n.push({_id:o._id,id:s,reward:u[1],time:o.group,checked:!!o.checked&&o.checked["m"+s]})}}}l.users=n}})}},logincheck:function(){if(l.info.stores[l.account])return uni.showLoading({mask:!0}),void s(c.collection("Ginfo").doc(l.account).get(),{success:function(t){if(uni.hideLoading(),t.data[0]){var n=t.data[0].pwd;if(u.hash.auth(l.password,n,"8fdeaa2948ecce44a582e5dbb1e5251f"))return uni.setStorage({key:"STOREKEY",data:{account:l.account,password:l.autologin?l.password:""}}),l.login=!0,void l.refreshda()}uni.showToast({title:"错误",icon:"error"})},fail:function(t){uni.hideLoading(),uni.showToast({title:"错误",icon:"error"})}});uni.showToast({title:"错误",icon:"error"})}}};n.default=f}).call(this,e("861b")["default"])},faf3:function(t,n,e){"use strict";e.d(n,"b",(function(){return i})),e.d(n,"c",(function(){return o})),e.d(n,"a",(function(){}));var i=function(){var t=this,n=t.$createElement,e=t._self._c||n;return e("v-uni-view",[t.login?e("v-uni-view",{staticStyle:{width:"700rpx","margin-left":"25rpx"}},[e("v-uni-button",{staticStyle:{"margin-top":"20rpx"},on:{click:function(n){arguments[0]=n=t.$handleEvent(n),t.refreshda.apply(void 0,arguments)}}},[t._v("刷新")]),e("v-uni-button",{staticStyle:{"margin-top":"20rpx"},on:{click:function(n){arguments[0]=n=t.$handleEvent(n),t.deltikscan(1)}}},[t._v("扫码-券码核销")]),e("v-uni-button",{staticStyle:{"margin-top":"20rpx"},on:{click:function(n){arguments[0]=n=t.$handleEvent(n),t.deltikscan.apply(void 0,arguments)}}},[t._v("输入券码编号核销")]),e("v-uni-view",[t._v("券码每日21点过期，网页端可微信扫码后复制券码到此处进行核销，小程序端可以直接扫码，也可以通过用户提供手机号后在下方核销。")]),e("v-uni-view",{staticStyle:{display:"flex","justify-content":"space-between","align-items":"center","font-size":"20rpx",margin:"20rpx 0"}},[e("v-uni-view",[t._v("今日中奖用户手机号")]),e("v-uni-view",[t._v("中奖批次")]),e("v-uni-view",[t._v("奖品")])],1),t._l(t.users,(function(n,i){return e("v-uni-view",{staticStyle:{display:"flex","justify-content":"space-between"}},[e("v-uni-button",{staticStyle:{"font-size":"20rpx",padding:"0",width:"80rpx"},attrs:{disabled:"未发放"==n.id||n.checked},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.deltik(n,i)}}},[t._v(t._s(n.checked?"已销":"核销"))]),e("v-uni-view",{staticStyle:{width:"40%"}},[t._v(t._s(n.id))]),e("v-uni-view",{staticStyle:{width:"30%"}},[t._v(t._s(n.time))]),e("v-uni-view",{staticStyle:{width:"30%"}},[t._v(t._s(n.reward))])],1)})),e("v-uni-view",{staticStyle:{height:"250rpx"}})],2):e("v-uni-view",{staticStyle:{padding:"30rpx"}},[e("v-uni-input",{attrs:{placeholder:"名称"},model:{value:t.account,callback:function(n){t.account=n},expression:"account"}}),e("v-uni-input",{staticStyle:{"margin-top":"20rpx"},attrs:{password:!0,placeholder:"密码"},model:{value:t.password,callback:function(n){t.password=n},expression:"password"}}),e("v-uni-view",{staticStyle:{display:"flex","justify-content":"flex-start","align-items":"center","font-size":"25rpx","margin-top":"20rpx"}},[e("v-uni-icon",{attrs:{type:t.autologin?"success":"circle"},on:{click:function(n){arguments[0]=n=t.$handleEvent(n),t.setauto.apply(void 0,arguments)}}}),e("v-uni-view",{staticStyle:{"margin-left":"10rpx"}},[t._v("记住密码")])],1),e("v-uni-button",{staticStyle:{"margin-top":"20rpx"},on:{click:function(n){arguments[0]=n=t.$handleEvent(n),t.logincheck.apply(void 0,arguments)}}},[t._v("登录")])],1)],1)},o=[]}}]);